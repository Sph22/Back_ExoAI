name: Auto-Update Exoplanet Data

on:
  schedule:
    # Ejecutar cada 6 horas: a las 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub Actions
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar actualizaci√≥n completa'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Auto-Update
        run: |
          echo "ü§ñ Iniciando actualizaci√≥n autom√°tica de datos..."
          
          # Endpoint seg√∫n el input
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
            ENDPOINT="https://back-exoai.onrender.com/auto-update/force"
            echo "üî• Modo: Actualizaci√≥n forzada"
          else
            ENDPOINT="https://back-exoai.onrender.com/auto-update"
            echo "‚úÖ Modo: Actualizaci√≥n inteligente (solo si hay cambios)"
          fi
          
          # Hacer request con token
          RESPONSE=$(curl -s -X POST \
            "$ENDPOINT?token=${{ secrets.TRAIN_TOKEN }}" \
            -H "Content-Type: application/json" \
            -w "\n%{http_code}")
          
          # Separar body y status code
          HTTP_BODY=$(echo "$RESPONSE" | sed '$d')
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          
          echo "üìä Status HTTP: $HTTP_STATUS"
          echo "üìÑ Respuesta:"
          echo "$HTTP_BODY" | jq '.' || echo "$HTTP_BODY"
          
          # Verificar √©xito
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ Actualizaci√≥n completada exitosamente"
            
            # Extraer informaci√≥n relevante
            STATUS=$(echo "$HTTP_BODY" | jq -r '.status // "unknown"')
            
            if [ "$STATUS" == "updated" ]; then
              ACCURACY=$(echo "$HTTP_BODY" | jq -r '.train_result.accuracy // "N/A"')
              echo "üéØ Modelo re-entrenado con accuracy: $ACCURACY"
            elif [ "$STATUS" == "no_changes" ]; then
              echo "‚ÑπÔ∏è No hay cambios en los datasets"
            fi
          else
            echo "‚ùå Error en la actualizaci√≥n"
            exit 1
          fi
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è La actualizaci√≥n autom√°tica fall√≥"
          echo "Revisa los logs en: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"